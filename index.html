<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>APP de Tatuagem</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
      text-align: center;
      padding: 40px;
    }
    input, textarea, button {
      width: 100%;
      max-width: 400px;
      margin: 10px auto;
      padding: 12px;
      border-radius: 6px;
      border: none;
      font-size: 16px;
      display: block;
    }
    button {
      background: #ff0055;
      color: #fff;
      cursor: pointer;
      font-weight: bold;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    img {
      max-width: 100%;
      margin-top: 20px;
      border-radius: 8px;
    }

    /* Loader */
    #loader {
      display: none;
      margin: 18px auto;
      width: 34px;
      height: 34px;
      border: 4px solid rgba(255,255,255,0.2);
      border-top-color: #ff0055;
      border-radius: 50%;
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .hint {
      opacity: 0.75;
      font-size: 13px;
      margin-top: 4px;
    }
  </style>
</head>
<body>

  <h1>Gerador de Arte para Tatuagem</h1>

  <input type="file" id="image" accept="image/*" />

  <textarea id="prompt" placeholder="Descreva o estilo da tatuagem (ex: traÃ§o fino, blackwork, line art)..."></textarea>

  <button id="btnGerar" onclick="gerar()">Gerar Arte</button>

  <div id="loader"></div>
  <div class="hint" id="status"></div>

  <div id="resultado"></div>

  <script>
    async function gerar() {
      const btn = document.getElementById("btnGerar");
      const loader = document.getElementById("loader");
      const status = document.getElementById("status");
      const resultadoDiv = document.getElementById("resultado");

      const file = document.getElementById("image").files[0];
      const prompt = (document.getElementById("prompt").value || "").trim();

      // âœ… validaÃ§Ãµes
      if (!file) {
        alert("Selecione uma imagem primeiro.");
        return;
      }
      if (!prompt) {
        alert("Escreva o prompt (o que vocÃª quer que a IA faÃ§a).");
        return;
      }

      // âœ… limite de tamanho (2MB)
      const MAX_BYTES = 2 * 1024 * 1024; // 2MB
      if (file.size > MAX_BYTES) {
        alert("Imagem muito grande. Use uma imagem de atÃ© 2MB.");
        return;
      }

      // limpa resultado anterior
      resultadoDiv.innerHTML = "";
      status.textContent = "";

      // âœ… converter imagem para base64
      const imageBase64 = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const b64 = String(reader.result).split(",")[1];
            if (!b64) return reject(new Error("Falha ao ler base64 da imagem."));
            resolve(b64);
          } catch (e) {
            reject(e);
          }
        };
        reader.onerror = () => reject(new Error("Erro ao ler o arquivo."));
        reader.readAsDataURL(file);
      });

      // âœ… request com try/catch/finally (spinner + erro)
      try {
        btn.disabled = true;
        loader.style.display = "block";
        status.textContent = "Gerando... aguarde";

        // ðŸ”¥ AQUI: manda o prompt do textarea
        // Sua API atual retorna: { imageBase64: "...." }
        const res = await fetch("/api/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            imageBase64: imageBase64,
            // Se sua API usar "style", deixe fixo:
            style: "clean",
            // E se vocÃª quiser tambÃ©m enviar prompt livre:
            prompt: prompt
          })
        });

        const data = await res.json().catch(() => ({}));

        // âœ… valida retorno
        if (!res.ok) {
          throw new Error(data?.error || `Erro HTTP ${res.status}`);
        }

        // âœ… sua API (generate.js) retorna imageBase64
        const outB64 = data?.imageBase64;
        if (!outB64) {
          throw new Error(data?.error || "Resposta sem imagem (imageBase64 vazio).");
        }

        // âœ… exibir
        resultadoDiv.innerHTML = `<img id="resultadoImg" src="data:image/png;base64,${outB64}" />`;
        status.textContent = "Pronto âœ…";

      } catch (err) {
        console.error(err);
        alert("Erro: " + (err?.message || err));
        status.textContent = "Erro ao gerar. Veja o console.";
      } finally {
        loader.style.display = "none";
        btn.disabled = false;
      }
    }
  </script>

</body>
</html>
